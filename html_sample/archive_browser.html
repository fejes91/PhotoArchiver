<html>
    <head>
        <title>Archive Browser</title>
        <meta charset="UTF-8">
        <script src="http://code.jquery.com/jquery-2.1.0.min.js"></script>
        <style>
            body{
                margin: 0px;
            }

            img{
                
                margin: 2px;
            }


            .keyword{
                border: 1px solid white;
                margin: 3px;
                padding: 3px 5px;
                display: inline-block;
                font-family: Helvetica;
            }

            .keyword:hover{
                color: green;
                border: 1px solid green;
            }

            #pictures a.top{
                font-size: 32px;
                margin: 20px;
                text-align: center;
                width: 100%;
                display: block;
            }

            #stat{
                font-size: 12px;
                display: block;
                width: 100%;
                text-align: center;
                margin: 10px;
            }

            #keywords{
                border: 1px solid grey;
            }

            #img_hover{
                position: absolute;
                color: black;
                font-size: 18px;
                text-align: center;
                background: white;
                opacity: 0.85;
                padding-top: 30px;
                z-index: 20;
            }

            #img_hover a{
                font-family: Helvetica;
                text-decoration: none;
                position: absolute;
                bottom: 0px;
                left: 0px;
                text-align: center;
                background: rgba(0,0,0,0.7);
                color: white;
                height: 30px;
                line-height: 30px;
            }

            #img_hover .date{
                font-family: Helvetica;
                position: absolute;
                top: 0px;
                left: 0px;
                text-align: center;
                background: rgba(0,0,0,0.7);
                color: white;
                height: 30px;
                line-height: 30px;
            }

            #img_hover a:hover{
                background: rgba(0,0,0,0.4);
            }

            #img_hover .keyword{
                font-size: 12px;
            }
        </style>
    </head>

    <body>
        <div id="search_box">
            <center>
                <form method="GET" id="searchFrom">
                    <input type="button" value="X" id="clear_search" style="width: 5%; height:30px;"/>
                    <input type="text" name="search" id="search_field" placeholder="Írj be kulcsszavakat " style="width: 60%; height:30px;"/>
                    <input type="submit" value="Keresés!" id="search_btn" style="width: 10%; height:30px; margin: 10px 0px;"/> 
                    <input type="button" value="Mutasd a kulcsszavakat" id="show_keywords" style="width: 10%; height:30px; margin: 10px 0px;"/>
                    <br>
                    <input type="button" value="X" id="clear_dates" style="width: 5%; height:30px;"/>
                    <input type="text" name="dateFrom" id="dateFrom" style="display: none;"/>
                    <input type="text" name="dateTo" id="dateTo" style="display: none"/>
                    </from>

                    <input type="text" max-length="4" id="yearFrom" style="width: 50px; height:30px;"/>
                    <input type="text" max-length="2" id="monthFrom" style="width: 30px; height:30px;"/>
                    <input type="text" max-length="2" id="dayFrom" style="width: 30px; height:30px;"/>-tól  

                    <input type="text" max-length="4" id="yearTo" style="width: 50px; height:30px;"/>
                    <input type="text" max-length="2" id="monthTo" style="width: 30px; height:30px;"/>
                    <input type="text" max-length="2" id="dayTo" style="width: 30px; height:30px;"/>-ig

            </center>
        </div>

        <div id="keywords" hidden></div>
        <div id="stat"></div>
        <div id="pictures"></div>
        <div id="img_hover"></div>

        <script>
            var resizeTimer;
            $(window).resize(function(){
                clearTimeout(resizeTimer);
                resizeTimer = window.setTimeout(function(){resizePictures();}, 1000);
            });
            $(window).ready(function() {
                $("#searchFrom").submit(function(){
                    $("#dateFrom").val($("#yearFrom").val() + "-" + $("#monthFrom").val() + "-" + $("#dayFrom").val());
                    $("#dateTo").val($("#yearTo").val() + "-" + $("#monthTo").val() + "-" + $("#dayTo").val());
                });

                $('input[max-length]').bind("keyup", function(){
                    console.log("asd");
                    if($(this).val().length == $(this).attr("max-length")){
                        $(this).next().focus();
                    }
                });

                searchStr = getURLParameter("search");
                dateFromStr = getURLParameter("dateFrom");
                dateToStr = getURLParameter("dateTo");
                var dateFromArray = dateFromStr.split("-");
                var dateToArray = dateToStr.split("-");
                $("#yearFrom").val(dateFromArray[0]);
                $("#monthFrom").val(dateFromArray[1]);
                $("#dayFrom").val(dateFromArray[2]);
                $("#yearTo").val(dateToArray[0]);
                $("#monthTo").val(dateToArray[1]);
                $("#dayTo").val(dateToArray[2]);

                if (typeof searchStr !== "undefined" && searchStr != "") {
                    $("#search_field").val(searchStr.trim());
                    searchArray = searchStr.trim().split(" ");
                    $("#pictures").html("");
                    meta = new Object(); //unió
                    filteredMeta = new Object(); //metszet
                    loadKeyword(0, searchArray);
                }
                else if(typeof dateFromStr != "undefined" && typeof dateToStr != "undefined" && dateFromStr != "" && dateToStr != "" ){
                    $("#dateFrom").val(dateFromStr.trim());
                    $("#dateTo").val(dateToStr.trim());
                    dateFrom = new Date(dateFromStr);
                    dateTo = new Date(dateToStr);
                    dateSearchArray = new Array();

                    loadJs("meta/dates/dateList.js", function() {
                        while(dateFrom <= dateTo){
                            var year = dateFrom.getFullYear();
                            var month = dateFrom.getMonth() + 1;
                            var day = dateFrom.getDate();
                            if(typeof dates[year] != "undefined"){
                                if(typeof dates[year][month] != "undefined"){
                                    if(typeof dates[year][month][day] != "undefined"){
                                        dateSearchArray.push(year + "/" + month + "/" + day);
                                    }
                                }
                            }
                            dateFrom.setDate(dateFrom.getDate() + 1);
                        } 
                        $("#pictures").html("");
                        meta = new Object(); //unió
                        filteredMeta = new Object(); //metszet
                        loadDate(0, dateSearchArray);
                    });
                    
                }

                $("#clear_search").click(function() {
                    $("#search_field").val("");
                });

                $("#clear_dates").click(function() {
                    $("#dateFrom").val("");
                    $("#dateTo").val("");
                });

                $("#show_keywords").click(function() {
                    initKeywordList();
                    $("#keywords").show();
                    $(this).hide();
                });

                
            });

            function resizePictures(){
                console.log("resizing...");
                images = $("img");
                var normalWidth = 300;
                var normalHeight = normalWidth * 2/3;
                imgPerRow = parseInt(window.innerWidth / normalWidth);

                for(var i = 0; i < images.length; i++){
                    //console.log("i: " + i);
                    if(i > 0 && (i + 1) % imgPerRow == 0){
                         filledSpace = 0;
                        for(var counter = i; counter > i - imgPerRow; counter--){
                            //console.log("counter: " + counter +  " - " + $(images[counter]).width() + " - " + $(images[counter]).height());
                            var width = $(images[counter]).width();
                            var height = $(images[counter]).height();
                            if(parseInt($(images[counter]).width()) > parseInt($(images[counter]).height())){ //fekvő
                                //console.log("fekvő");
                                if(normalWidth * (height / width) > normalHeight){ //négyzeteshez közeli, ezzel van, baj....
                                    $(images[counter]).height(normalHeight);
                                    $(images[counter]).width(normalHeight * (width / height));
                                }
                                else{
                                    $(images[counter]).width(normalWidth);
                                    $(images[counter]).height(normalWidth * (height / width));
                                }
                            }
                            else{//álló
                                //console.log("álló")
                                $(images[counter]).height(normalHeight);
                                $(images[counter]).width(normalHeight * (width / height));
                            }
                            filledSpace += $(images[counter]).width();
                        }

                        extraSpace = $("#pictures").innerWidth() - 5 - filledSpace - (imgPerRow * parseInt($("img").css("margin")) * 2);

                        for(var counter = i; counter > i - imgPerRow; counter--){
                            var width = $(images[counter]).width();
                            var height = $(images[counter]).height();
                            //console.log("counter:" + counter + "w/h: " + width + "/" + height);
                            $(images[counter]).width(width * (1 + (extraSpace / filledSpace)));
                            var newWidth = $(images[counter]).width();
                            //console.log("new width: " + newWidth);

                            $(images[counter]).height(height * (newWidth / width));
                            
                            
                            var newHeight = $(images[counter]).height();
                            //console.log("new height: " + newHeight);
                        }
                    }
                    else{
                        $(images[i]).height($(images[i-1]).height());
                    }
                }
            }

            function loadJs(url, callback) {
                var head = document.getElementsByTagName('head')[0];
                var script = document.createElement('script');
                script.type = 'text/javascript';
                script.src = url;
                script.addEventListener('error', function(){callback();}, true);

                head.appendChild(script);
                script.onreadystatechange = callback;
                script.onload = callback;
            }

            getURLParameter = function(sParam) {
                var sPageURL = window.location.search.substring(1);
                var sURLVariables = sPageURL.split('&');
                for (var i = 0; i < sURLVariables.length; i++) {
                    var sParameterName = sURLVariables[i].split('=');
                    if (sParameterName[0] == sParam) {
                        return decodeURIComponent(sParameterName[1]).split('+').join(' ').trim();
                    }
                }
            }

            function initKeywordList() {
                keywordlist = new Array();
                loadJs("meta/list/keywordlist.js", function() {
                    keywordlist.sort();

                    meta = new Object();
                    filteredMeta = new Object();
                    count = new Object();
                    countKeyword(0, keywordlist);
                });
            }

            function filterByDate(){
                $("#dateFrom").val(dateFromStr.trim());
                $("#dateTo").val(dateToStr.trim());
                dateFrom = new Date(dateFromStr);
                dateTo = new Date(dateToStr);
                
                for(key in filteredMeta){
                    dateArray = key.split("/");
                    var date = new Date(dateArray[0] + "-" + dateArray[1] + "-" + dateArray[2]);
                    //console.log("datefrom: " + dateFrom + " dateTo: " + dateTo + " date: " + date);
                    if(dateFrom > date || dateTo < date){
                        pictureCount--;
                        delete filteredMeta[key];
                    }
                }

                showPictures();
                
            }

            function loadKeyword(i, array) {
                if (i < array.length) {
                    loadJs("meta/" + array[i] + ".js", function() {
                        //console.log(array[i] + " loaded");
                        loadKeyword(i + 1, array);
                    });
                }
                else {
                    if(typeof dateFromStr != "undefined" && typeof dateToStr != "undefined" && dateFromStr != "" && dateToStr != "" ){
                        filterByDate();
                    }
                    else{
                       showPictures(); 
                    }
                    
                }
            }

            function loadDate(i, array) {
                if (i < array.length) {
                    loadJs(array[i] + "/desc.js", function() {
                        //console.log(array[i] + " loaded");
                        loadDate(i + 1, array);
                    });
                }
                else {
                    showPictures();
                }
            }

            function showPictures(){
                for (key in filteredMeta) {
                    var keywords = filteredMeta[key];
                    $("#pictures").append('<img full="' + key + '" src="thumbnails/' + key + '?rnd=' + parseInt(Math.random() * 1000) + '" keywords="' + keywords + '">');
                }
                $("#stat").html(pictureCount + " fotó betöltve!");
                $("#pictures").append('<a href="#" class="top">Ugrás a tetejére</a>');

                $("img").bind('click', function(event) {
                    event.preventDefault();
                    $this = $(this);
                    $("#img_hover").show();

                    var keywordArray = $this.attr("keywords").split(" ");
                    $("#img_hover").html("");

                    var dateArray = $this.attr("src").split("/");
                    $("#img_hover").append('<span class="date">' + dateArray[1] + '-' + dateArray[2] + '-' + dateArray[3] + '</span>');
                    for (key in keywordArray) {
                        var display = keywordArray[key].trim();
                        if(display == "$"){
                            display = "untagged";
                        }
                        $("#img_hover").append('<div class="keyword" keyword="' + keywordArray[key] + '">' + display + "</div>");
                    }

                    $("#img_hover").append('<a href="' + $this.attr("full") + '">Vetítés</a>');

                    $(".keyword").unbind();
                    $(".keyword").bind('click', function() {
                        $("#search_field").val($("#search_field").val() + " " + $(this).attr("keyword"));
                        $("#search_field").val($("#search_field").val().trim());
                    });

                    $("#img_hover").width($this.width()).height($this.height() - 30).offset($this.offset());
                    $("#img_hover a").width($this.width());
                    $("#img_hover .date").width($this.width());
                    
                });
                $("#img_hover").bind('mouseleave', function() {
                    $("#img_hover").hide();
                });

                loadCount = 0;
                $("img").load(function(){
                    loadCount++;
                    if(loadCount == pictureCount){
                        resizePictures();
                    }
                });
                
            }

            function countKeyword(i, array) {
                if (i < array.length) {
                    metaCount = 0;
                    searchArray = new Array();
                    loadJs("meta/" + array[i] + ".js", function() {
                        count[array[i]] = metaCount;
                        countKeyword(i + 1, array);
                    });
                }
                else {
                    var min = 9999999;
                    var max = 0;
                    for (key in count) {
                        if (count[key] < min) {
                            min = count[key];
                        }
                        if (count[key] > max) {
                            max = count[key];
                        }
                    }

                    //keyswordsSorted = Object.keys(count).sort(function(a,b){return count[b]-count[a]});
                    for (var key in count) {
                        var fontSize = (count[key] * 50 / max);
                        if (fontSize < 10) {
                            fontSize += 10;
                        }

                        var display = key;
                        if(display == "$"){
                            display = "untagged";
                        }
                        $("#keywords").append('<div class="keyword" keyword="' + key + '" style="font-size: ' + fontSize + '">' + display + ' (' + count[key] + ')</div>');
                    }
                    $(".keyword").unbind();
                    $(".keyword").bind('click', function() {
                        $("#search_field").val($("#search_field").val() + " " + $(this).attr("keyword"));
                        $("#search_field").val($("#search_field").val().trim());
                    });
                }
            }

            function addPicture(picUrl, keyword) {
                if(typeof meta[picUrl] == "undefined"){
                    meta[picUrl] = 1;
                }
                else{
                    meta[picUrl]++;
                }

                if(typeof searchArray == "undefined" || meta[picUrl] == searchArray.length || searchArray.length == 0){ //ha van annyi előfordulás ahány kulcsszó akkor benne van a metszetben
                    filteredMeta[picUrl] = keyword;

                    if(typeof pictureCount == "undefined"){
                        pictureCount = 0;
                    }
                    pictureCount++;
                }

                if (typeof metaCount != "undefined") {
                    metaCount++;
                }
                
                
            }

            function addDate(dateStr){
                var dateArray = dateStr.split("-");
                var year = dateArray[0];
                var month = dateArray[1];
                var day = dateArray[2];
                if(typeof dates == "undefined"){
                    dates = new Object();
                }

                if(typeof dates[year] == "undefined"){
                    dates[year] = new Object();
                }

                if(typeof dates[year][month] == "undefined"){
                    dates[year][month] = new Object();
                }

                if(typeof dates[year][month][day] == "undefined"){
                    dates[year][month][day] = true;
                }
            }


        </script>
    </body>
</html>