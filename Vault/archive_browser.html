<html>
    <head>
        <title>Archive Browser</title>
        <meta charset="UTF-8">
        <script src="http://code.jquery.com/jquery-2.1.0.min.js"></script>
        <script src="jquery.base64.js"></script>
        <style>
            body{
                margin: 0px;
            }

            img{
                
                margin: 2px;
            }


            .keyword{
                border: 1px solid white;
                margin: 3px;
                padding: 3px 5px;
                display: inline-block;
                font-family: Helvetica;
            }

            .keyword:hover{
                color: green;
                border: 1px solid green;
            }

            #pictures a.top{
                font-size: 32px;
                margin: 20px;
                text-align: center;
                width: 100%;
                display: block;
            }

            #pictures{
                display: inline-block;
            }

            #stat{
                font-size: 17px;
                display: inline-block;
                width: 100%;
                text-align: center;
                margin-top: 10px;
            }

            .pagination{
                display: inline-block;
                width: 100%;
                text-align: center;
                margin: 10px auto;
                margin-top: 0px;
            }

            #keywords{
                border: 1px solid grey;
            }

            #img_hover{
                position: absolute;
                color: black;
                font-size: 18px;
                text-align: center;
                background: white;
                opacity: 0.85;
                padding-top: 30px;
                z-index: 20;
            }

            #img_hover a{
                font-family: Helvetica;
                text-decoration: none;
                position: absolute;
                bottom: 0px;
                left: 0px;
                text-align: center;
                background: rgba(0,0,0,0.7);
                color: white;
                height: 30px;
                line-height: 30px;
            }

            #img_hover .date{
                font-family: Helvetica;
                position: absolute;
                top: 0px;
                left: 0px;
                text-align: center;
                background: rgba(0,0,0,0.7);
                color: white;
                height: 30px;
                line-height: 30px;
            }

            #img_hover a:hover{
                background: rgba(0,0,0,0.4);
            }

            #img_hover .keyword{
                font-size: 12px;
            }
            
            #slide_layer{
				width: 100%;
				height: 100%;
				background-color: rgba(255,255,255,0.95);
				position: fixed;
				top: 0px;
				left: 0px;
				z-index: 998;
				display: none;
			}
			
			#slide{
				margin: 20px auto;
				border: 3px solid red;
				display: block;
			}
			
			#slide img{
				margin: 0px auto;
			}

            .pageBtn{
                border: 1px solid green;
                margin: 2px;
                padding: 10px;
                display: inline-block;
            }

            .pageBtn.active{
                border: 3px solid green;
            }

            .pagerBtn{
                width: 60px;
                height: 40px;
                font-size: 16px;
                font-weight: bold;
            }

        </style>
    </head>

    <body>
        <div id="search_box">
            
                <form method="GET" id="searchFrom">
                    <div style="float: left; margin: 10px 0px 10px 20px; width:35%">
                        <input type="button" value="X" id="clear_search" style="width: 40px; height:30px;"/>
                        <input type="text" name="search" id="search_field" placeholder="Írj be kulcsszavakat " style="width: 75%; height:30px;"/>
                        <input type="text" name="dateFrom" id="dateFrom" style="display: none;"/>
                        <input type="text" name="dateTo" id="dateTo" style="display: none"/>
                        
                        <input type="text" name="page" id="page" style="display: none"/>
                        <input type="button" value="Kulcsszavak" id="show_keywords" style="width: 150px; height:30px;"/>
                    </div>

                    <div style="margin: 10px 0px 10px 20px; width:25%; float: left; text-align: center;">
                        <input type="submit" value="Keresés!" id="search_btn" style="width: 80%; height:50px; "/>
                    </div>

                    <div style="float: right; margin: 10px 20px 10px 0px; text-align: right; width: 35%">
                        <input type="button" value="X" id="clear_dates" style="width: 40px; height:30px;"/>
                        <input type="text" max-length="4" id="yearFrom" class="dateField" style="width: 50px; height:30px;"/>
                        <input type="text" max-length="2" id="monthFrom" class="dateField" style="width: 30px; height:30px;"/>
                        <input type="text" max-length="2" id="dayFrom" class="dateField" style="width: 30px; height:30px;"/>-tól  

                        <input type="text" max-length="4" id="yearTo" class="dateField" style="width: 50px; height:30px;"/>
                        <input type="text" max-length="2" id="monthTo" class="dateField" style="width: 30px; height:30px;"/>
                        <input type="text" max-length="2" id="dayTo" class="dateField" style="width: 30px; height:30px;"/>-ig
                        <input type="button" value="Máig!" id="today" style="width: 75px; height:30px;"/>
                    </div>

                </form>
           
                
            
        </div>

        <div id="keywords" hidden></div>
        <div id="stat"></div>
        <table class="pagination">
            <tr>
                <td class="prevPage"></td>
                <td class="pages" style="width: 300px;"></td>
                <td class="nextPage"></td>
            </tr>
        </table>
        <div id="pictures"></div>
        <div class="pagination"></div>
        <div id="img_hover"></div>
        <div id="slide_layer"><div id="slide"></div></div>
		
        <script>
            var dictionary = {};
            var imagePerPage = 20;
            var actualPage = 0;
            var resizeTimer;
            var needToClear = true;
            var resetPagination = true;
            $(window).resize(function(){
                clearTimeout(resizeTimer);
                resizeTimer = window.setTimeout(function(){resizePictures();}, 500);
            });
            $(window).ready(function() {
                $("#searchFrom").submit(function(){
                    $("#dateFrom").val($("#yearFrom").val() + "-" + $("#monthFrom").val() + "-" + $("#dayFrom").val());
                    $("#dateTo").val($("#yearTo").val() + "-" + $("#monthTo").val() + "-" + $("#dayTo").val());
                    if(resetPagination){
                        $("#page").val("1");
                    }
                    
                });

                $('input[max-length]').bind("keyup", function(event){
                    if($(this).val().length == $(this).attr("max-length")){
						needToClear = false;
                        $(this).next().focus();
                    }
                });

                /*$("input").on('change', function(){
                    $("#page").val("1");
                });*/
                
                $('.dateField').focus(function(){
					if(needToClear){
						$(this).val('');
					}
					else{
						$(this).select();
					}
				});

                searchStr = getURLParameter("search");
                dateFromStr = getURLParameter("dateFrom");
                dateToStr = getURLParameter("dateTo");
                actualPage = parseInt(getURLParameter("page"));

                if(typeof actualPage != "undefined" ){
                    $("#page").val(actualPage);
                }
                else{
                    $("#page").val("1");
                }               

                if(typeof dateFromStr != "undefined" && typeof dateToStr != "undefined"){
                    var dateFromArray = dateFromStr.split("-");
                    var dateToArray = dateToStr.split("-");
                    $("#yearFrom").val(dateFromArray[0]);
                    $("#monthFrom").val(dateFromArray[1]);
                    $("#dayFrom").val(dateFromArray[2]);
                    $("#yearTo").val(dateToArray[0]);
                    $("#monthTo").val(dateToArray[1]);
                    $("#dayTo").val(dateToArray[2]);
                }
                

                if (typeof searchStr !== "undefined" && searchStr != "") {
                    $("#search_field").val(searchStr.trim());
                    searchArray = searchStr.trim().split(" ");
                    $("#pictures").html("");
                    meta = new Object(); //unió
                    filteredMeta = new Object(); //metszet
                    loadKeyword(0, searchArray);
                }
                else if(typeof dateFromStr != "undefined" && typeof dateToStr != "undefined" && dateFromStr != "" && dateToStr != "" ){
                    $("#dateFrom").val(dateFromStr.trim());
                    $("#dateTo").val(dateToStr.trim());
                    dateFrom = new Date(dateFromStr);
                    dateFrom.setHours(0);
                    dateTo = new Date(dateToStr);
                    dateTo.setHours(0);
                    dateSearchArray = new Array();

                    loadJs("meta/dates/dateList.js", function() {
                        while(dateFrom <= dateTo){
                            var year = dateFrom.getFullYear();
                            var month = dateFrom.getMonth() + 1;
                            var day = dateFrom.getDate();
                            if(typeof dates[year] != "undefined"){
                                if(typeof dates[year][month] != "undefined"){
                                    if(typeof dates[year][month][day] != "undefined"){
                                        dateSearchArray.push(year + "/" + month + "/" + day);
                                    }
                                }
                            }
                            dateFrom.setDate(dateFrom.getDate() + 1);
                        } 
                        $("#pictures").html("");
                        meta = new Object(); //unió
                        filteredMeta = new Object(); //metszet
                        loadDate(0, dateSearchArray);
                    });
                    
                }

                $("#clear_search").click(function() {
                    $("#search_field").val("");
                });

                $("#today").click(function(){
                    var today = new Date();
                    $("#yearTo").val(today.getFullYear());
                    $("#monthTo").val(today.getMonth() + 1);
                    $("#dayTo").val(today.getDate());
                });

                $("#clear_dates").click(function() {
                    $("#yearFrom").val("").next().val('').next().val('');
                    $("#yearTo").val("").next().val('').next().val('');
                });

                $("#show_keywords").click(function() {
                    initKeywordList();
                    $("#keywords").css('display', 'inline-block');
                    $(this).hide();
                });

				$("#slide_layer").click(function(){$("#slide_layer").hide();});
                $("#slide").click(function(){return false;});
            });

            function resizePictures(){
                images = $("#pictures img");
                var normalWidth = 300;
                var normalHeight = normalWidth * 2/3;
                var unresizedImgCount = 0;
                imgPerRow = parseInt(window.innerWidth / (normalWidth + parseInt($("img").css("margin")) * 2));

                for(var i = 0; i < images.length; i++){
                    //console.log("i: " + i);
                    //if(i > 0 && (i + 1) % imgPerRow == 0){
                    unresizedImgCount++;
					if(i > 0 && unresizedImgCount == imgPerRow){
                        filledSpace = 0;
                        
                        var counter = i;
                        var recalculate = false;
                        var imgPerThisRow = imgPerRow;
                        while(counter > i - imgPerThisRow){
                            //console.log("counter: " + counter +  " - " + $(images[counter]).width() + " - " + $(images[counter]).height());
                            var width = images[counter].naturalWidth;
                            var height = images[counter].naturalHeight;
                            $(images[counter]).height(200);
							$(images[counter]).width(200 * (width/height));
 
                            filledSpace += $(images[counter]).width();
                            
							counter--;
							if(counter == i - imgPerThisRow){
								if(filledSpace < $("#pictures").innerWidth() * 0.6 && i + 1 < images.length){
									imgPerThisRow++;
									i++;
									counter = i;
									filledSpace = 0;
									//console.log("imgperthisrow incremented: " + imgPerThisRow + " counter: " + counter);
								}
							}
                        }

                        extraSpace = $("#pictures").innerWidth() - 5 - filledSpace - (imgPerThisRow * parseInt($("img").css("margin")) * 2);
						//console.log("FILLEDSPACE: " + filledSpace + " EXTRASPACE: " + extraSpace + " imgperthisrow: " + imgPerThisRow);
                        
                        for(var counter = i; counter > i - imgPerThisRow; counter--){
                            var width = $(images[counter]).width();
                            var height = $(images[counter]).height();
                            //console.log("counter:" + counter + " w/h: " + width + "/" + height);
                            $(images[counter]).width(width * (1 + extraSpace / filledSpace));
                            //$(images[counter]).width(width + (Math.abs(extraSpace) / imgPerThisRow));
                            var newWidth = $(images[counter]).width();
                            //console.log("new width: " + newWidth);
                            $(images[counter]).height(height * (newWidth / width));
                            var newHeight = $(images[counter]).height();
                            //console.log("new height: " + newHeight);
                        }
                        unresizedImgCount = 0;
                    }
                    else{
                        $(images[i]).height($(images[i-1]).height());
                        $(images[i]).width($(images[i]).height() * (images[i].naturalWidth / images[i].naturalHeight));
                    }
                }
            }

            function loadJs(url, callback) {
                //console.log("load js: " + url);
                var head = document.getElementsByTagName('head')[0];
                var script = document.createElement('script');
                script.type = 'text/javascript';
                script.src = url;
                script.charset = "utf-8";
                script.addEventListener('error', function(){callback();}, true);
                head.appendChild(script);
                script.onreadystatechange = callback;
                script.onload = callback;
            }

            getURLParameter = function(sParam) {
                var sPageURL = window.location.search.substring(1);
                var sURLVariables = sPageURL.split('&');
                for (var i = 0; i < sURLVariables.length; i++) {
                    var sParameterName = sURLVariables[i].split('=');
                    if (sParameterName[0] == sParam) {
                        return decodeURIComponent(sParameterName[1]).split('+').join(' ').trim();
                    }
                }
            }

            function initKeywordList() {
                keywordlist = new Array();
                loadJs("meta/list/keywordlist.js", function() {
                    keywordlist.sort();
                    meta = new Object();
                    filteredMeta = new Object();
                    count = new Object();
                    countKeyword(0, keywordlist);
                });
            }

            function filterByDate(){
                $("#dateFrom").val(dateFromStr.trim());
                $("#dateTo").val(dateToStr.trim());
                dateFrom = new Date(dateFromStr);
                dateFrom.setHours(0);
                dateTo = new Date(dateToStr);
                dateTo.setHours(0);
                
                for(key in filteredMeta){
                    dateArray = key.split("/");
                    var date = new Date(dateArray[0] + "-" + dateArray[1] + "-" + dateArray[2]).setHours(0);
                    
                    if(dateFrom > date || dateTo < date){
                        //console.log("DELETE: datefrom: " + dateFrom + " dateTo: " + dateTo + " date: " + date);
                        pictureCount--;
                        delete filteredMeta[key];
                    }
                }
                showPictures(actualPage);
            }

            function loadKeyword(i, array) {
                if (i < array.length) {
                    loadJs("meta/list/" + getDictFileName(array[i]) + ".js", function(){
                        loadJs("meta/" + dictionary[array[i]] + ".js", function() {
                            loadKeyword(i + 1, array);
                        });
                    });
                }
                else {
                    if(typeof dateFromStr != "undefined" && typeof dateToStr != "undefined" && dateFromStr != "" && dateToStr != "" ){
                        filterByDate();
                    }
                    else{
                       showPictures(actualPage); 
                    }
                }
            }

            function loadDate(i, array) {
                if (i < array.length) {
                    loadJs(array[i] + "/desc.js", function() {
                        //console.log(array[i] + " loaded");
                        loadDate(i + 1, array);
                    });
                }
                else {
                    showPictures(actualPage);
                }
            }

            function showPictures(pageNum){
                $("#pictures").html('');
                var i = 0;
                var firstPic = (pageNum - 1) * imagePerPage;
                //console.log("pagenum: " + pageNum);
                //console.log("firstpic: " + firstPic);
                for (key in filteredMeta) {
                    if(i < firstPic){
                        i++;
                        continue;
                    }

                    if(i === firstPic + imagePerPage){
                        break;
                    }
                    //console.log(i);

                    var keywords = filteredMeta[key];
                    $("#pictures").append('<img full="' + key + '" src="thumbnails/' + key + '?rnd=' + parseInt(Math.random() * 1000) + '" keywords="' + keywords + '">');
                    ++i;
                }
                
                $("#stat").html(pictureCount + " találat");
                //$("#pictures").append('<a href="#" class="top">Ugrás a tetejére</a>');
                getPagination();
                $("img").bind('click', function(event) {
                    event.preventDefault();
                    $this = $(this);
                    $("#img_hover").show();

                    var keywordArray = $this.attr("keywords").split(" ");
                    $("#img_hover").html("");

                    var dateArray = $this.attr("src").split("/");
                    $("#img_hover").append('<span class="date">' + dateArray[1] + '-' + dateArray[2] + '-' + dateArray[3] + '</span>');
                    for (key in keywordArray) {
                        var display = keywordArray[key].trim();
                        if(display == "$"){
                            display = "untagged";
                        }
                        $("#img_hover").append('<div class="keyword" keyword="' + keywordArray[key] + '">' + display + "</div>");
                    }

                    $("#img_hover").append('<a href="' + $this.attr("full") + '">Vetítés</a>');
                    
                    $("#img_hover a").click(function(event){
						event.preventDefault();
						slideShow($this);
					});
                    $(".keyword").unbind();
                    $(".keyword").bind('click', function() {
                        $("#search_field").val($("#search_field").val() + " " + $(this).attr("keyword"));
                        $("#search_field").val($("#search_field").val().trim());
                    });

                    $("#img_hover").width($this.width()).height($this.height() - 30).offset($this.offset());
                    $("#img_hover a").width($this.width());
                    $("#img_hover .date").width($this.width());
                    
                });
                $("#img_hover").bind('mouseleave', function() {
                    $("#img_hover").hide();
                });

                loadCount = 0;
                $("img").load(function(){
                    loadCount++;
                    if(loadCount == imagePerPage || (actualPage === Math.ceil(pictureCount / imagePerPage)) && loadCount === pictureCount % imagePerPage){
                        resizePictures();
                    }
                });
            }

            function getPagination(){
                var str = ""
                var actual = parseInt(getURLParameter("page"));
                var numberOfPages = Math.ceil(pictureCount / imagePerPage);

                if(numberOfPages > 1 ){
                    $(".prevPage").html('<button class="pagerBtn" id="prevPage"> < </button>');
                }

                if(numberOfPages > 7 && actual > 3){
                    str += '<span class="pageBtn">1</span>';
                    if(actual > 4){
                        str += "...";    
                    }
                }

                for(var i = 1; i <= numberOfPages; ++i){
                    if(numberOfPages > 7 && (i < actual - 2 || i > actual + 2)){
                        continue;
                    }

                    str += '<span class="pageBtn';
                    if(i === actual){
                        str += ' active';
                    }
                    str += '">' + i + '</span>';
                }

                if(actual < numberOfPages - 3){
                    str += "...";    
                }
                if(numberOfPages > 7 && actual < numberOfPages - 2){
                    str += '<span class="pageBtn">' + numberOfPages + '</span>';   
                }

                if(numberOfPages > 1){
                    $(".nextPage").html('<button class="pagerBtn" id="nextPage"> > </button>');
                }

                $(".pages").html(str);

                $(".pagination .pageBtn:not(.active)").click(function(){
                    var pageNum = $(this).text();
                    console.log(pageNum);
                    $("#page").val(pageNum);
                    resetPagination = false;
                    $("#searchFrom").submit();
                });

                $("#nextPage").unbind();
                $("#prevPage").unbind();
                if(actual < numberOfPages){
                    $("#nextPage").bind('click', function(){
                        $(".pageBtn.active").next().click();
                    });
                }
                if(actual > 1){
                    $("#prevPage").bind('click', function(){
                            $(".pageBtn.active").prev().click();
                    });
                }
            }
            
            function slideShow($img){
				$("#slide_layer").show();
				$("#slide").html('<img src="' + $img.attr('full') + '">');
				
				console.log($img.get(0).naturalWidth + "  -  " + $img.get(0).naturalHeight)
				if($img.get(0).naturalWidth > $img.get(0).naturalHeight){//fekvő
					$("#slide, #slide img").css("width", $(window).innerWidth() * 0.9);
				}
				else{
					$("#slide, #slide img").css("height", $(window).innerHeight() * 0.85);
				}
				
				$("#slide img").bind('click');
				$("#slide img").bind('click', function(){
					if($img.next().next().length > 0){
						slideShow($img.next());
					}
				});
			}

            function countKeyword(i, array) {
                if (i < array.length) {
                    metaCount = 0;
                    searchArray = new Array();

                    loadJs("meta/list/" + getDictFileName(array[i]) + ".js", function(){
                        loadJs("meta/" + dictionary[array[i]] + ".js", function() {
                            count[array[i]] = metaCount;
                            countKeyword(i + 1, array);
                        });
                    });
                }
                else {
                    var min = 9999999;
                    var max = 0;
                    for (key in count) {
                        if (count[key] < min) {
                            min = count[key];
                        }
                        if (count[key] > max) {
                            max = count[key];
                        }
                    }

                    //keyswordsSorted = Object.keys(count).sort(function(a,b){return count[b]-count[a]});
                    for (var key in count) {
                        var fontSize = (count[key] * 50 / max);
                        if (fontSize < 10) {
                            fontSize += 10;
                        }

                        var display = key;
                        if(display == "$"){
                            display = "untagged";
                        }
                        $("#keywords").append('<div class="keyword" keyword="' + key + '" style="font-size: ' + fontSize + '">' + decodeURIComponent(display) + ' (' + count[key] + ')</div>');
                    }
                    $(".keyword").unbind();
                    $(".keyword").bind('click', function() {
                        $("#search_field").val($("#search_field").val() + " " + $(this).attr("keyword"));
                        $("#search_field").val($("#search_field").val().trim());
                    });
                }
            }

            function addPicture(picUrl, keyword) {
                if(typeof meta[picUrl] == "undefined"){
                    meta[picUrl] = 1;
                }
                else{
                    meta[picUrl]++;
                }

                if(typeof searchArray == "undefined" || meta[picUrl] == searchArray.length || searchArray.length == 0){ //ha van annyi előfordulás ahány kulcsszó akkor benne van a metszetben
                    filteredMeta[picUrl] = keyword;

                    if(typeof pictureCount == "undefined"){
                        pictureCount = 0;
                    }
                    pictureCount++;
                }

                if (typeof metaCount != "undefined") {
                    metaCount++;
                }
            }

            function addDate(dateStr){
                var dateArray = dateStr.split("-");
                var year = dateArray[0];
                var month = dateArray[1];
                var day = dateArray[2];
                if(typeof dates == "undefined"){
                    dates = new Object();
                }

                if(typeof dates[year] == "undefined"){
                    dates[year] = new Object();
                }

                if(typeof dates[year][month] == "undefined"){
                    dates[year][month] = new Object();
                }

                if(typeof dates[year][month][day] == "undefined"){
                    dates[year][month][day] = true;
                }
            }

            function addToDictionary(keyword, hash){
                console.log("loading: " + keyword + " - " + hash);
                dictionary[keyword] = hash;
            }

            function getDictFileName(keyword){
                var first = keyword[0];
                if(first === "ö"){
                    return "o";
                }
                else if(first === "ü"){
                    return "u";
                }
                else if(first === "ó"){
                    return "o";
                }
                else if(first === "ő"){
                    return "o";
                }
                else if(first === "ú"){
                    return "u";
                }
                else if(first === "é"){
                    return "e";
                }
                else if(first === "á"){
                    return "a";
                }
                else if(first === "ű"){
                    return "u";
                }
                else if(first === "í"){
                    return "i";
                }

                return first;
            }
            
        </script>
    </body>
</html>
